#!/bin/rc

scheddir=$home/lib/srs/sched-sm2
ifs='
	'

item=$1
old=`{awk -F'	' -v 'item='$item '$1==item{printf $4+1"\t"$5}' < $scheddir/_index}
reps=$old(1)
oldease=$old(2)
score=$2

awk -F'	' \
	-v 'item='$item \
	-v 'score='$score \
	-v 'oldease='$oldease \
	-v 'reps='$reps \
	-v 'scheduler=sm2' \
	'
	function new_ivl(reps, ease) {
		if(reps <= 1)
			return 1
		if(reps == 2)
			return 6

		return new_ivl(reps-1, ease)*ease
	}

	function new_ease(ease, score) {
		return ease+(0.1-(5-score)*(0.08+(5-score)*0.02))
	}

	BEGIN {
		"date -n" | getline now
		today = int(now / 60 / 60 / 24)
		if(score < 3) {
			ease = oldease
			ivl = 1
			lapse = "lapse"
		} else {
			ease = new_ease(oldease, score)
			ivl = new_ivl(reps, ease)
		}

		print now "\t" ivl "\t" ease "\t" lapse >> (ENVIRON["scheddir"]"/"item)
		due = (lapse ? today : today+ivl)
		reps = (lapse ? 0 : reps)
	}
	$2>=due && !done {
		print item "\t" due "\t" scheduler "\t" reps "\t" ease "\t"
		done=1
	}
	$1!=item {
		print
	}
	END {
		if(!done)
			print item "\t" due "\t" scheduler "\t" reps "\t" ease "\t"
	}' \
 <$scheddir/_index >$scheddir/_index.new
mv $scheddir/_index.new $scheddir/_index
